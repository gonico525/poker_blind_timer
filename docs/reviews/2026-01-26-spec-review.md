# 機能仕様書レビュー報告書

**レビュー日**: 2026-01-26
**レビュー対象**: docs/specs/ 配下の全機能仕様書
**目的**: 並行開発における結合試験の円滑化に向けた要件整理状況の確認
**レビュアー**: システムアーキテクト

---

## 1. 総合評価

### 評価サマリー

| 観点 | 評価 | コメント |
|------|------|---------|
| 機能要件の網羅性 | ◎ 優良 | 要求仕様書の機能要件を十分にカバー |
| 機能別の詳細度 | ◎ 優良 | 実装可能なレベルで詳細化されている |
| データモデル定義 | ◎ 優良 | TypeScript型定義が明確 |
| 機能間インターフェース | △ 要改善 | Context間の責務・イベント通知が不明確 |
| 結合仕様 | △ 要改善 | 機能間の連携フローが分散している |
| 初期化・起動仕様 | × 不足 | アプリ起動シーケンスの定義がない |

### 結論

仕様書は**機能単位では十分な詳細度**を持っていますが、**機能間のインターフェース定義**に関する仕様が不足しています。並行開発を開始する前に、インターフェース定義書の追加作成が必要です。

---

## 2. 検出された課題

### 2.1 【高】Context間のアクション定義と責務境界が不明確

**問題の詳細**

`LOAD_PRESET` アクションが複数のContextで言及されているが、どちらが責務を持つか不明確。

```
presets.md（features/presets.md:行番号参照）:
  loadPreset → dispatch({ type: 'LOAD_PRESET', payload: { preset } })
  ※ useSettingsのdispatchを使用と記載

01-architecture.md（TournamentContext）:
  | { type: 'LOAD_PRESET'; payload: { preset: Preset } }
  ※ TournamentContextのアクションとして定義
```

**影響度**: 高
**影響範囲**: プリセット機能、タイマー機能、ブラインド機能の結合

**対策**: アクション責務マトリクスの作成（インターフェース定義書に記載）

---

### 2.2 【高】機能間のイベント通知メカニズムが未定義

**問題の詳細**

`timer.md` では音声通知関数を呼び出しているが、関数の定義場所・実装方法が不明。

```typescript
// timer.md より抜粋
if (crossedOneMinute && state.timer.status === 'running') {
  notifyAudioEvent('WARNING_1MIN');  // ← この関数の定義場所が不明
}
```

`audio.md` では `useEffect` で状態監視しているが、Reducer内での直接呼び出しとの整合性が不明。

**影響度**: 高
**影響範囲**: タイマー機能と音声機能の結合

**対策**: イベント通知パターンの統一（下表参照）

| 方式 | 実装方法 | 推奨度 | 理由 |
|------|----------|--------|------|
| A. フック内監視 | useEffect で remainingTime を監視 | ◎ 推奨 | シンプル、テスト容易 |
| B. カスタムイベント | CustomEvent + addEventListener | △ | 複雑、デバッグ困難 |
| C. コールバック注入 | Reducerにコールバックを渡す | × | アンチパターン |

---

### 2.3 【高】ユーティリティ関数のファイルパスに不整合

**問題の詳細**

各仕様書で参照されているパスが一貫していない。

| 仕様書 | 記載されているパス |
|--------|-------------------|
| timer.md | `import { formatTime } from '@/utils/timeFormat';` |
| blinds.md | `import { formatBlindLevel } from '@/utils/format';` |
| 02-data-models.md | `export function formatTime(seconds: number)` |

**影響度**: 高
**影響範囲**: 全機能

**対策**: ユーティリティファイル配置の確定（インターフェース定義書に記載）

---

### 2.4 【中】アプリ初期化シーケンスが未定義

**問題の詳細**

起動時の初期化順序が明確でない。

- ストレージからデータ読み込み
- デフォルトプリセットとのマージ
- Context初期化
- KeyboardServiceのイベントリスナー登録
- AudioServiceの音声プリロード

**影響度**: 中
**影響範囲**: アプリ全体の起動時動作

**対策**: 初期化シーケンス図の追加（インターフェース定義書に記載）

---

### 2.5 【中】グローバルな通知UI（Toast/Alert）の設計がない

**問題の詳細**

エラーハンドリングの記述は各所にあるが、UIへの通知方法が統一されていない。

| 仕様書 | 記載内容 |
|--------|---------|
| storage.md | `alert('ストレージ容量が不足しています');` |
| presets.md | `alert('インポートエラー: ...');` |
| 各所 | `window.confirm('...')` の使用 |

**影響度**: 中
**影響範囲**: UI/UX の一貫性

**対策**: NotificationContext または useNotification フックの共通設計

---

### 2.6 【中】音声ファイルのスタブ/モック方針が未定義

**問題の詳細**

- `public/sounds/` に配置すべきファイルの準備方針が不明
- テスト時の音声モック方法も不明確

**影響度**: 中
**影響範囲**: 音声機能の開発・テスト

**対策**:
1. ダミー音声ファイル（無音または短いビープ）をリポジトリに含める
2. テストでは AudioService をモック化する方針を明記

---

### 2.7 【中】休憩ロジックの詳細な結合仕様

**問題の詳細**

休憩に関して複数の仕様書に散在しており、全体像が把握しにくい。

| 仕様書 | 記載内容 |
|--------|---------|
| 02-data-models.md | `shouldTakeBreak()` 関数定義 |
| features/blinds.md | レベル進行時の休憩判定 |
| features/timer.md | 自動レベル進行時の休憩処理 |

**特に不明確な点**:
- 休憩終了後、タイマーは `idle` 状態で待機か、自動開始か

**影響度**: 中
**影響範囲**: タイマー機能、ブラインド機能の結合

**対策**: 休憩のステートマシン図を追加

---

### 2.8 【低】TypeScript型のエクスポート戦略

**問題の詳細**

型定義が `src/types/` と各ドメインモデルの両方に存在する可能性。

| 仕様書 | 記載内容 |
|--------|---------|
| 02-data-models.md | 型を直接定義 |
| 01-architecture.md | `src/types/domain.ts` を参照 |

**影響度**: 低
**影響範囲**: 開発時のインポートパス

**対策**: 型エクスポート戦略の明文化

---

## 3. 推奨アクション一覧

| # | 項目 | 優先度 | 対応ドキュメント | ステータス |
|---|------|--------|-----------------|-----------|
| 1 | Context間のアクション責務マトリクス作成 | **高** | インターフェース定義書 | 要作成 |
| 2 | イベント通知方式の確定 | **高** | インターフェース定義書 | 要作成 |
| 3 | ユーティリティのファイル配置確定 | **高** | インターフェース定義書 | 要作成 |
| 4 | 初期化シーケンス図の追加 | 中 | インターフェース定義書 | 要作成 |
| 5 | 通知UI（Toast）の共通設計 | 中 | インターフェース定義書 | 要作成 |
| 6 | ダミー音声ファイルの準備方針 | 中 | インターフェース定義書 | 要作成 |
| 7 | 休憩のステートマシン図追加 | 中 | インターフェース定義書 | 要作成 |
| 8 | 型エクスポート戦略の明文化 | 低 | インターフェース定義書 | 要作成 |

---

## 4. 結論と次のステップ

### 開発開始前に必須の対応

以下の3点は**開発開始前に必ず確定すべき**です：

1. **Context間のアクション責務**
   - 誰がどのアクションを発行し、誰が処理するか

2. **イベント通知メカニズム**
   - タイマー→音声などの連携方法

3. **共通ユーティリティのファイル配置**
   - インポートパスの統一

### 推奨する対応

**インターフェース定義書（04-interface-definitions.md）** を新規作成し、上記の課題を解決する仕様を追加することを推奨します。

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2026-01-26 | 初版作成 | システムアーキテクト |
